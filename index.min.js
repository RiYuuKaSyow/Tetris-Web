let e,t,n,o,i,c,l,r,f,s,a=[],u={pos:{x:0,y:0},matrix:[[]]},m=null;const h=[0,"T","O","I","J","L","Z","S","Trash"];let d=["#000","#a0a","#ec0","#0ee","#00f","#f50","#d13","#0c0","#aaa"],y=["#333","#c6c","#ca0","#0cc","#00d","#c20","#c02","#0a0","#fff"];var g=[];let p=[0,1,1,1,1,1,1,1],x=[8,8,8,8,8,8,8,8,8,8],k=[];const E=1,w=2,I=0;let S,M,R,v=1e3,T=0,b=I,B=!1,L=!1,A=!1,G=!1,_="ArrowLeft",C="ArrowRight",j="ArrowDown",D="Space",P="ArrowUp",F="KeyZ",K="KeyX",Z="KeyC",J="KeyP",O="Escape",U=null,q=!1,X=0,z=0,H=0,N=!1,Q=!1,V=[],W=[];function Y(e){V.push(document.getElementById(e))}function $(e){for(let t=0;t<e.length;t++)V.push(document.getElementById(e[t]))}function ee(o){e=document.getElementById(o),t=e.getContext("2d"),n=e.height/22}function te(e){o=document.getElementById(e),i=o.getContext("2d")}function ne(e){c=document.getElementById(e),l=c.getContext("2d")}function oe(e,t){r=document.getElementById(e),s=t}function ie(e){W.push(document.getElementById(e))}function ce(e){keyC=e}function le(e){D=e}function re(e){F=e}function fe(e){K=e}function se(e){P=e}function ae(){img1=new Image,img2=new Image,img3=new Image,img4=new Image,img1.src="./suisei/IMG_20200510_153757.jpg",img2.src="./suisei/IMG_20200510_153800.jpg",img3.src="./suisei/IMG_20200510_153805.jpg",img4.src="./suisei/IMG_20200510_153802.jpg",g=["#000",img1,img2,img3,img4,img1,img2,img3,img4],G=!0}function ue(e){f=document.getElementById(e)}function me(e){m=document.getElementById(e)}function he(e){switch(e){case"clean40":L=!0;break;case"cleanTrash":A=!0}de()}function de(){null!==r&&(r.style.display="none"),document.addEventListener("keydown",Fe),b=E,Ie(),we(),Ee(),Se(),Re(),!1!==A&&(Me(),S=setTimeout(Pe,15*v)),Le(u),Ye(),ze(),He(),nt(),tt(k),R=Date.now(),M=setTimeout(rt,1),ve(0)}function ye(){b=I,window.cancelAnimationFrame(ve),window.clearTimeout(M),document.removeEventListener("keydown",Fe),L=!1,!0===A&&clearTimeout(S),A=!1,null!==r&&(r.style.display=s)}function ge(){b===E?(b=w,window.cancelAnimationFrame(ve),window.clearTimeout(M),document.removeEventListener("keydown",Fe),document.addEventListener("keydown",Xe),!0===A&&clearTimeout(S),xe()):b===w&&pe()}function pe(){b===w&&(b=E,ke(),document.removeEventListener("keydown",Xe),document.addEventListener("keydown",Fe),R=Date.now(),M=setTimeout(rt,1),ve(0),!1!==A&&(S=setTimeout(Pe,15*v)))}function xe(){void 0!==f&&(f.style.display="flex"),ct()}function ke(){void 0!==f&&(f.style.display="none"),We(U),ze(),He(),nt(),tt(k)}function Ee(){k=[];for(let e=0;e<6;e++){let e=0;do{e=Math.floor(7*Math.random())+1}while(!(p[e]>0));p[e]--,k.push(be(h[e]))}}function we(){p=[0,1,1,1,1,1,1,1]}function Ie(){a=[];for(let e=0;e<22;e++){a.push([]);for(let t=0;t<10;t++)a[e].push(0)}}function Se(){q=!1,U=null}function Me(){x=[8,8,8,8,8,8,8,8,8,8];for(let e=21;e>13;e--)x[Math.floor(10*Math.random())]=0,a[e]=x,x=[8,8,8,8,8,8,8,8,8,8]}function Re(){v=1e3,droplasttime=0,T=0,U=null,q=!1,X=0,z=0,H=0,N=!1}function ve(e=0){b===E&&(e-droplasttime>=v&&(Te(),droplasttime=e),z%30!=0||0===z||B||(je(),B=!0),lt(z),ze(a),!0!==G?(Ne(a,{x:0,y:0}),Ne(u.matrix,u.pos)):(Qe(a,{x:0,y:0}),Qe(u.matrix,u.pos)),Ve(u.matrix,u.pos),He(),!0===L&&z>=40&&ye(),requestAnimationFrame(ve))}function Te(){u.pos.y++;let e=Ce(a,u);e&&(X>1||Q)?(u.pos.y--,Ae(a,u)):e?(X++,u.pos.y--):Q=!1}function be(e){let t;switch(e){case"T":t=[[0,1,0],[1,1,1],[0,0,0]];break;case"O":t=[[2,2],[2,2]];break;case"I":t=[[0,0,0,0],[3,3,3,3],[0,0,0,0],[0,0,0,0]];break;case"J":t=[[0,0,0],[4,0,0],[4,4,4]];break;case"L":t=[[0,0,0],[0,0,5],[5,5,5]];break;case"Z":t=[[0,0,0],[6,6,0],[0,6,6]];break;case"S":t=[[0,0,0],[0,7,7],[7,7,0]]}return t}function Be(){let e=k.shift();N=mt(e),De()&&we();let t=0;do{t=Math.floor(7*Math.random())+1}while(!(p[t]>0));return p[t]--,k.push(be(h[t])),tt(k),e}function Le(t){t.pos={x:e.width/n/2-1,y:0},t.matrix=Be()}function Ae(e,t){console.log(Q);try{if(t.matrix.forEach((n,o)=>{n.forEach((n,i)=>{0!==t.matrix[o][i]&&(e[o+t.pos.y][i+t.pos.x]=t.matrix[o][i])})}),!0===N&&!0===Q){let n=[];n=t.pos.y+2>21?[e[t.pos.y][t.pos.x],e[t.pos.y][t.pos.x+2]]:[e[t.pos.y][t.pos.x],e[t.pos.y][t.pos.x+2],e[t.pos.y+2][t.pos.x],e[t.pos.y+2][t.pos.x+2]],console.log(n.filter(e=>0===e).length),n.filter(e=>0===e).length<=1&&ft()}}catch(n){ye()}Ge(e);for(let o=0;o<10;o++)if(0!==e[1][o]||0!==e[0][o])return void ye();Le(t),q=!1,X=0}function Ge(e){for(let t=e.length-1;t>=0;t--)if(!1!==_e(e[t])){for(let n=t;n>0;n--)e[n]=e[n-1];e[0]=[0,0,0,0,0,0,0,0,0,0],t++,z++,B=!1}}function _e(e){for(let t=0;t<e.length;t++)if(0===e[t])return!1;return!0}function Ce(e,t){for(let n=0;n<t.matrix.length;n++)for(let o=0;o<t.matrix[n].length;o++)if(0!==t.matrix[n][o]&&0!==(e[n+t.pos.y]&&e[n+t.pos.y][o+t.pos.x]))return!0;return!1}function je(){v<=100||(v-=100)}function De(){for(let e=1;e<p.length;e++)if(0!==p[e])return!1;return!0}function Pe(){(x=[8,8,8,8,8,8,8,8,8,8])[Math.floor(10*Math.random())]=0,a.shift(),a.push(x),S=setTimeout(Pe,15*v)}function Fe(){switch(event.code){case _:Ke(-1);break;case C:Ke(1);break;case j:Ze(1);break;case D:Je();break;case P:Ue();break;case F:Ue(!1);break;case K:Ue();break;case Z:qe();break;case J:case O:ge()}}function Ke(e){u.pos.x+=e,Ce(a,u)?u.pos.x-=e:Q=!1}function Ze(e){u.pos.y+=e,Ce(a,u)?u.pos.y-=e:Q=!1}function Je(){u.pos.y=ut(),Q=!1,console.log(Q),Ae(a,u)}function Oe(e,t=!0){for(let n=0;n<e.length;n++)for(let t=0;t<n;t++)[e[n][t],e[t][n]]=[e[t][n],e[n][t]];t?e.forEach((t,n)=>{e[n].reverse()}):e.reverse()}function Ue(e=!0){const t=u.pos.x,n=u.pos.y;let o=1,i=!1;for(Oe(u.matrix,e);Ce(a,u);)if(u.pos.x+=o,(o=-(o+(o>0?1:-1)))>a[0].length){if(!(u.pos.y<22))return u.pos.x=t,u.pos.y=n,void Oe(u.matrix,!e);u.pos.x=t,o=1,u.pos.y++,i=!0}Q=!0}function qe(){let t=be(ht());!1===q&&(null===U?(U=t,Le(u)):(u.matrix=U,U=t,u.pos={x:e.width/n/2-1,y:0},N=mt(u.matrix))),q=!0,We(U)}function Xe(){switch(event.code){case J:case O:pe()}}function ze(){for(let e=0;e<22;e++)for(let o=0;o<10;o++)t.fillStyle=d[0],t.fillRect(o*n,e*n,1*n,1*n),t.strokeStyle=y[0],t.strokeRect(o*n,e*n,1*n,1*n);t.strokeStyle="#eee",t.strokeRect(0,0,e.width,e.height)}function He(){t.fillStyle="#fff",t.fillRect(0,0,10*n,2*n)}function Ne(e,o){e.forEach((i,c)=>{i.forEach((i,l)=>{0!==e[c][l]&&(t.fillStyle=d[e[c][l]],t.fillRect((o.x+l)*n,(o.y+c)*n,1*n,1*n),t.strokeStyle="#fff",t.strokeRect((o.x+l)*n,(o.y+c)*n,1*n,1*n))})})}function Qe(e,o){e.forEach((i,c)=>{i.forEach((i,l)=>{0!==e[c][l]&&(t.drawImage(g[e[c][l]],(o.x+l)*n,(o.y+c)*n,n,n),t.strokeStyle=d[e[c][l]],t.strokeRect((o.x+l)*n,(o.y+c)*n,1*n,1*n))})})}function Ve(e,o){let i=ut();e.forEach((c,l)=>{c.forEach((c,r)=>{0!==e[l][r]&&(t.strokeStyle=y[e[l][r]],t.strokeRect((o.x+r)*n,(i+l)*n,1*n,1*n))})})}function We(e){Ye(),!0!==G?$e(e):et(e)}function Ye(){for(let e=0;e<4;e++)for(let t=0;t<4;t++)i.fillStyle=d[0],i.fillRect(t*n,e*n,1*n,1*n),i.strokeStyle=y[0],i.strokeRect(t*n,e*n,1*n,1*n);i.strokeStyle="#eee",i.strokeRect(0,0,o.width,o.height)}function $e(e){let t=2-Math.floor(e.length/2);e.forEach((o,c)=>{o.forEach((o,l)=>{0!==e[c][l]&&(i.fillStyle=d[e[c][l]],i.fillRect((l+t)*n,(c+t)*n,1*n,1*n),i.strokeStyle="#fff",i.strokeRect((l+t)*n,(c+t)*n,1*n,1*n))})})}function et(e){let t=2-Math.floor(e.length/2);e.forEach((o,c)=>{o.forEach((o,l)=>{0!==e[c][l]&&(i.drawImage(g[e[c][l]],(l+t)*n,(c+t)*n,1*n,1*n),i.strokeStyle=d[e[c][l]],i.strokeRect((l+t)*n,(c+t)*n,1*n,1*n))})})}function tt(e){nt(),!0!==G?ot(e):it(e)}function nt(){for(let e=0;e<6;e++){for(let t=0;t<4;t++)for(let o=0;o<4;o++)l.fillStyle=d[0],l.fillRect(2*o*n/3,c.height/6*e+2*t*n/3,2*n/3,2*n/3),l.strokeStyle=y[0],l.strokeRect(2*o*n/3,c.height/6*e+2*t*n/3,2*n/3,2*n/3);l.strokeStyle="#fff",l.strokeRect(0,c.height/6*e,c.width,c.height/6)}}function ot(e){e.forEach((e,t)=>{let o=2-Math.floor(e.length/2);e.forEach((i,r)=>{i.forEach((i,f)=>{0!==e[r][f]&&(l.fillStyle=d[e[r][f]],l.fillRect(2*(f+o)*n/3,2*(r+o)*n/3+c.height/6*t,2*n/3,2*n/3),l.strokeStyle="#fff",l.strokeRect(2*(f+o)*n/3,2*(r+o)*n/3+c.height/6*t,2*n/3,2*n/3))})})})}function it(e){e.forEach((e,t)=>{let o=2-Math.floor(e.length/2);e.forEach((i,r)=>{i.forEach((i,f)=>{0!==e[r][f]&&(l.drawImage(g[e[r][f]],2*(f+o)*n/3,2*(r+o)*n/3+c.height/6*t,2*n/3,2*n/3),l.strokeStyle=d[e[r][f]],l.strokeRect(2*(f+o)*n/3,2*(r+o)*n/3+c.height/6*t,2*n/3,2*n/3))})})})}function ct(){t.fillStyle=d[0],t.fillRect(0,2*n,10*n,20*n),l.fillStyle=d[0],l.fillRect(0,0,8*n/3,48*n/3),i.fillStyle=d[0],i.fillRect(0,0,4*n,4*n)}function lt(e){if(V!==[])for(let t=0;t<V.length;t++)V[t].innerText=e}function rt(){let e=Date.now();if(H+=e-R,R=Date.now(),W!==[])for(let t=0;t<W.length;t++)W[t].innerText=Math.floor(H/1e3/60)+"分"+Math.floor(H/1e3%60)+"秒"+(Array(3).join("0")+H%1e3).slice(-3);M=setTimeout(rt,1)}function ft(){st(),setTimeout(at,250),setTimeout(st,500),setTimeout(at,1e3)}function st(){null!==m&&(m.style.display="block")}function at(){null!==m&&(m.style.display="none")}function ut(){let e=u.pos.y;for(;!Ce(a,{pos:{x:u.pos.x,y:e},matrix:u.matrix});)e++;return e-1}function mt(e){for(let t=0;t<3;t++)for(let n=0;n<3;n++){if(1===e[t][n])return!0;if(0!==e[t][n])return!1}}function ht(){for(let e=0;e<u.matrix.length;e++)for(let t=0;t<u.matrix[0].length;t++)if(0!==u.matrix[e][t])return h[u.matrix[e][t]]}function dt(e){document.getElementById(e).style.display="none"}ee("Tetris"),te("saveMatrix"),ne("nexts"),Y("Score"),ie("Time"),oe("GameMenu","flex"),ue("PauseMenu"),me("Tspin");let yt=new URLSearchParams(window.location.search);!0===yt.has("suisei")&&ae(),document.getElementById("Basic").addEventListener("click",function(){he("basic"),dt("GameMenu")}),document.getElementById("Forty").addEventListener("click",function(){he("clean40"),dt("GameMenu")}),document.getElementById("Trash").addEventListener("click",function(){he("cleanTrash"),dt("GameMenu")}),document.getElementById("Continue").addEventListener("click",function(){pe(),dt("PauseMenu")}),document.getElementById("Endbtn").addEventListener("click",function(){ye(),dt("PauseMenu")});