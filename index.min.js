let e,t,n,o,i,r,c,l,f,a,s=[],u={pos:{x:0,y:0},matrix:[[]]};const m=[0,"T","O","I","J","L","Z","S","Trash"];let h=["#000","#a0a","#ec0","#0ee","#00f","#f50","#d13","#0c0","#aaa"],d=["#333","#c6c","#ca0","#0cc","#00d","#c20","#c02","#0a0","#fff"];var y=[];let g=[0,1,1,1,1,1,1,1],p=[8,8,8,8,8,8,8,8,8,8],k=[];const x=1,E=2,w=0;let I,M,S,v=1e3,R=0,T=w,b=!1,B=!1,L=!1,A=!1,G="ArrowLeft",_="ArrowRight",C="ArrowDown",j="Space",D="ArrowUp",P="KeyZ",F="KeyX",K="KeyC",Z="KeyP",J="Escape",O=null,U=!1,q=0,X=0,z=0,H=!1,N=!1,Q=[],V=[];function W(e){Q.push(document.getElementById(e))}function Y(e){for(let t=0;t<e.length;t++)Q.push(document.getElementById(e[t]))}function $(o){e=document.getElementById(o),t=e.getContext("2d"),n=e.height/22}function ee(e){o=document.getElementById(e),i=o.getContext("2d")}function te(e){r=document.getElementById(e),c=r.getContext("2d")}function ne(e,t){l=document.getElementById(e),a=t}function oe(e){V.push(document.getElementById(e))}function ie(e){keyC=e}function re(e){j=e}function ce(e){P=e}function le(e){F=e}function fe(e){D=e}function ae(){img1=new Image,img2=new Image,img3=new Image,img4=new Image,img1.src="./suisei/IMG_20200510_153757.jpg",img2.src="./suisei/IMG_20200510_153800.jpg",img3.src="./suisei/IMG_20200510_153805.jpg",img4.src="./suisei/IMG_20200510_153802.jpg",y=["#000",img1,img2,img3,img4,img1,img2,img3,img4],A=!0}function se(e){f=document.getElementById(e)}function ue(e){switch(e){case"clean40":B=!0;break;case"cleanTrash":L=!0}me()}function me(){null!==l&&(l.style.display="none"),document.addEventListener("keydown",De),T=x,Ee(),xe(),ke(),we(),Me(),!1!==L&&(Ie(),I=setTimeout(je,15*v)),be(u),Ve(),qe(),Xe(),et(),$e(k),S=Date.now(),M=setTimeout(it,1),Se(0)}function he(){T=w,window.cancelAnimationFrame(Se),window.clearTimeout(M),document.removeEventListener("keydown",De),B=!1,!0===L&&clearTimeout(I),L=!1,null!==l&&(l.style.display=a)}function de(){T===x?(T=E,window.cancelAnimationFrame(Se),window.clearTimeout(M),document.removeEventListener("keydown",De),document.addEventListener("keydown",Ue),!0===L&&clearTimeout(I),ge()):T===E&&ye()}function ye(){T===E&&(T=x,pe(),document.removeEventListener("keydown",Ue),document.addEventListener("keydown",De),S=Date.now(),M=setTimeout(it,1),Se(0),!1!==L&&(I=setTimeout(je,15*v)))}function ge(){void 0!==f&&(f.style.display="flex")}function pe(){void 0!==f&&(f.style.display="none")}function ke(){k=[];for(let e=0;e<6;e++){let e=0;do{e=Math.floor(7*Math.random())+1}while(!(g[e]>0));g[e]--,k.push(Re(m[e]))}}function xe(){g=[0,1,1,1,1,1,1,1]}function Ee(){s=[];for(let e=0;e<22;e++){s.push([]);for(let t=0;t<10;t++)s[e].push(0)}}function we(){U=!1,O=null}function Ie(){p=[8,8,8,8,8,8,8,8,8,8];for(let e=21;e>13;e--)p[Math.floor(10*Math.random())]=0,s[e]=p,p=[8,8,8,8,8,8,8,8,8,8]}function Me(){v=1e3,droplasttime=0,R=0,O=null,U=!1,q=0,X=0,z=0,H=!1}function Se(e=0){T===x&&(e-droplasttime>=v&&(ve(),droplasttime=e),X%30!=0||0===X||b||(_e(),b=!0),ot(X),qe(s),!0!==A?(ze(s,{x:0,y:0}),ze(u.matrix,u.pos)):(He(s,{x:0,y:0}),He(u.matrix,u.pos)),Ne(u.matrix,u.pos),Xe(),!0===B&&X>=40&&he(),requestAnimationFrame(Se))}function ve(){u.pos.y++,Ge(s,u)&&q>1?(u.pos.y--,Be(s,u)):Ge(s,u)?(N=!1,q++,u.pos.y--):N=!1}function Re(e){let t;switch(e){case"T":t=[[0,1,0],[1,1,1],[0,0,0]];break;case"O":t=[[2,2],[2,2]];break;case"I":t=[[0,0,0,0],[3,3,3,3],[0,0,0,0],[0,0,0,0]];break;case"J":t=[[0,0,0],[4,0,0],[4,4,4]];break;case"L":t=[[0,0,0],[0,0,5],[5,5,5]];break;case"Z":t=[[0,0,0],[6,6,0],[0,6,6]];break;case"S":t=[[0,0,0],[0,7,7],[7,7,0]]}return t}function Te(){let e=k.shift();H=ct(e),Ce()&&xe();let t=0;do{t=Math.floor(7*Math.random())+1}while(!(g[t]>0));return g[t]--,k.push(Re(m[t])),$e(k),e}function be(t){t.pos={x:e.width/n/2-1,y:0},t.matrix=Te()}function Be(e,t){try{t.matrix.forEach((n,o)=>{n.forEach((n,i)=>{0!==t.matrix[o][i]&&(e[o+t.pos.y][i+t.pos.x]=t.matrix[o][i])})})}catch(n){he()}Le(e);for(let o=0;o<10;o++)if(0!==e[1][o]||0!==e[0][o])return void he();!0===H&&!0===N&&console.log("T-spin"),be(t),U=!1,q=0}function Le(e){for(let t=e.length-1;t>=0;t--)if(!1!==Ae(e[t])){for(let n=t;n>0;n--)e[n]=e[n-1];e[0]=[0,0,0,0,0,0,0,0,0,0],t++,X++,b=!1}}function Ae(e){for(let t=0;t<e.length;t++)if(0===e[t])return!1;return!0}function Ge(e,t){for(let n=0;n<t.matrix.length;n++)for(let o=0;o<t.matrix[n].length;o++)if(0!==t.matrix[n][o]&&0!==(e[n+t.pos.y]&&e[n+t.pos.y][o+t.pos.x]))return!0;return!1}function _e(){v<=100||(v-=100)}function Ce(){for(let e=1;e<g.length;e++)if(0!==g[e])return!1;return!0}function je(){(p=[8,8,8,8,8,8,8,8,8,8])[Math.floor(10*Math.random())]=0,s.shift(),s.push(p),I=setTimeout(je,15*v)}function De(){switch(event.code){case G:Pe(-1);break;case _:Pe(1);break;case C:Fe(1);break;case j:Ke();break;case D:Je();break;case P:Je(!1);break;case F:Je();break;case K:Oe();break;case Z:case J:de()}}function Pe(e){u.pos.x+=e,Ge(s,u)&&(u.pos.x-=e)}function Fe(e){u.pos.y+=e,Ge(s,u)&&(u.pos.y-=e)}function Ke(){u.pos.y=rt(),Be(s,u)}function Ze(e,t=!0){for(let n=0;n<e.length;n++)for(let t=0;t<n;t++)[e[n][t],e[t][n]]=[e[t][n],e[n][t]];t?e.forEach((t,n)=>{e[n].reverse()}):e.reverse()}function Je(e=!0){const t=u.pos.x,n=u.pos.y;let o=1,i=!1;for(Ze(u.matrix,e);Ge(s,u);)if(u.pos.x+=o,(o=-(o+(o>0?1:-1)))>s[0].length){if(!(u.pos.y<22))return u.pos.x=t,u.pos.y=n,void Ze(u.matrix,!e);u.pos.x=t,o=1,u.pos.y++,i=!0}!0===i&&(N=!0)}function Oe(){let t=Re(lt());!1===U&&(null===O?(O=t,be(u)):(u.matrix=O,O=t,u.pos={x:e.width/n/2-1,y:0},H=ct(u.matrix))),U=!0,Qe(O)}function Ue(){switch(event.code){case Z:case J:ye()}}function qe(){for(let e=0;e<22;e++)for(let o=0;o<10;o++)t.fillStyle=h[0],t.fillRect(o*n,e*n,1*n,1*n),t.strokeStyle=d[0],t.strokeRect(o*n,e*n,1*n,1*n);t.strokeStyle="#eee",t.strokeRect(0,0,e.width,e.height)}function Xe(){t.fillStyle="#fff",t.fillRect(0,0,10*n,2*n)}function ze(e,o){e.forEach((i,r)=>{i.forEach((i,c)=>{0!==e[r][c]&&(t.fillStyle=h[e[r][c]],t.fillRect((o.x+c)*n,(o.y+r)*n,1*n,1*n),t.strokeStyle="#fff",t.strokeRect((o.x+c)*n,(o.y+r)*n,1*n,1*n))})})}function He(e,o){e.forEach((i,r)=>{i.forEach((i,c)=>{0!==e[r][c]&&(t.drawImage(y[e[r][c]],(o.x+c)*n,(o.y+r)*n,n,n),t.strokeStyle=h[e[r][c]],t.strokeRect((o.x+c)*n,(o.y+r)*n,1*n,1*n))})})}function Ne(e,o){let i=rt();e.forEach((r,c)=>{r.forEach((r,l)=>{0!==e[c][l]&&(t.strokeStyle=d[e[c][l]],t.strokeRect((o.x+l)*n,(i+c)*n,1*n,1*n))})})}function Qe(e){Ve(),!0!==A?We(e):Ye(e)}function Ve(){for(let e=0;e<4;e++)for(let t=0;t<4;t++)i.fillStyle=h[0],i.fillRect(t*n,e*n,1*n,1*n),i.strokeStyle=d[0],i.strokeRect(t*n,e*n,1*n,1*n);i.strokeStyle="#eee",i.strokeRect(0,0,o.width,o.height)}function We(e){let t=2-Math.floor(e.length/2);e.forEach((o,r)=>{o.forEach((o,c)=>{0!==e[r][c]&&(i.fillStyle=h[e[r][c]],i.fillRect((c+t)*n,(r+t)*n,1*n,1*n),i.strokeStyle="#fff",i.strokeRect((c+t)*n,(r+t)*n,1*n,1*n))})})}function Ye(e){let t=2-Math.floor(e.length/2);e.forEach((o,r)=>{o.forEach((o,c)=>{0!==e[r][c]&&(i.drawImage(y[e[r][c]],(c+t)*n,(r+t)*n,1*n,1*n),i.strokeStyle=h[e[r][c]],i.strokeRect((c+t)*n,(r+t)*n,1*n,1*n))})})}function $e(e){et(),!0!==A?tt(e):nt(e)}function et(){for(let e=0;e<6;e++){for(let t=0;t<4;t++)for(let o=0;o<4;o++)c.fillStyle=h[0],c.fillRect(2*o*n/3,r.height/6*e+2*t*n/3,2*n/3,2*n/3),c.strokeStyle=d[0],c.strokeRect(2*o*n/3,r.height/6*e+2*t*n/3,2*n/3,2*n/3);c.strokeStyle="#fff",c.strokeRect(0,r.height/6*e,r.width,r.height/6)}}function tt(e){e.forEach((e,t)=>{let o=2-Math.floor(e.length/2);e.forEach((i,l)=>{i.forEach((i,f)=>{0!==e[l][f]&&(c.fillStyle=h[e[l][f]],c.fillRect(2*(f+o)*n/3,2*(l+o)*n/3+r.height/6*t,2*n/3,2*n/3),c.strokeStyle="#fff",c.strokeRect(2*(f+o)*n/3,2*(l+o)*n/3+r.height/6*t,2*n/3,2*n/3))})})})}function nt(e){e.forEach((e,t)=>{let o=2-Math.floor(e.length/2);e.forEach((i,l)=>{i.forEach((i,f)=>{0!==e[l][f]&&(c.drawImage(y[e[l][f]],2*(f+o)*n/3,2*(l+o)*n/3+r.height/6*t,2*n/3,2*n/3),c.strokeStyle=h[e[l][f]],c.strokeRect(2*(f+o)*n/3,2*(l+o)*n/3+r.height/6*t,2*n/3,2*n/3))})})})}function ot(e){if(Q!==[])for(let t=0;t<Q.length;t++)Q[t].innerText=e}function it(){let e=Date.now();if(z+=e-S,S=Date.now(),V!==[])for(let t=0;t<V.length;t++)V[t].innerText=Math.floor(z/1e3/60)+"分"+Math.floor(z/1e3%60)+"秒"+(Array(3).join("0")+z%1e3).slice(-3);M=setTimeout(it,1)}function rt(){let e=u.pos.y;for(;!Ge(s,{pos:{x:u.pos.x,y:e},matrix:u.matrix});)e++;return e-1}function ct(e){for(let t=0;t<3;t++)for(let n=0;n<3;n++){if(1===e[t][n])return!0;if(0!==e[t][n])return!1}}function lt(){for(let e=0;e<u.matrix.length;e++)for(let t=0;t<u.matrix[0].length;t++)if(0!==u.matrix[e][t])return m[u.matrix[e][t]]}function ft(e){document.getElementById(e).style.display="none"}$("Tetris"),ee("saveMatrix"),te("nexts"),W("Score"),oe("Time"),ne("GameMenu","flex"),se("PauseMenu");let at=new URLSearchParams(window.location.search);!0===at.has("suisei")&&ae(),document.getElementById("Basic").addEventListener("click",function(){ue("basic"),ft("GameMenu")}),document.getElementById("Forty").addEventListener("click",function(){ue("clean40"),ft("GameMenu")}),document.getElementById("Trash").addEventListener("click",function(){ue("cleanTrash"),ft("GameMenu")}),document.getElementById("Continue").addEventListener("click",function(){ye(),ft("PauseMenu")}),document.getElementById("Endbtn").addEventListener("click",function(){he(),ft("PauseMenu")});